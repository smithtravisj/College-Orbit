generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String    @id @default(cuid())
  email                    String    @unique
  passwordHash             String
  name                     String?
  username                 String?   @unique
  profileImage             String?   // Base64 data URL
  resetPasswordToken       String?   @unique
  resetPasswordTokenExpiry DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  isAdmin                  Boolean   @default(false)
  lastLogin                DateTime?
  sessionInvalidatedAt     DateTime?
  calendarToken            String?   @unique // Token for iCal subscription URL

  // UTM tracking
  utmSource    String?
  utmCampaign  String?

  // College relation
  collegeId String?
  college   College? @relation(fields: [collegeId], references: [id])

  // Subscription fields
  subscriptionTier      String    @default("trial")
  subscriptionStatus    String    @default("trialing")
  trialStartedAt        DateTime  @default(now())
  trialEndsAt           DateTime?
  stripeCustomerId      String?   @unique
  stripeSubscriptionId  String?   @unique
  subscriptionPlan      String?
  subscriptionExpiresAt DateTime?
  lifetimePremium       Boolean   @default(false)

  collegeRequests           CollegeRequest[]
  courses                   Course[]
  customQuickLinks          CustomQuickLink[]
  sessions                  UserSession[]
  deadlines                 Deadline[]
  exams                     Exam[]
  excludedDates             ExcludedDate[]
  featureRequests           FeatureRequest[]
  folders                   Folder[]
  gpaEntries                GpaEntry[]
  issueReports              IssueReport[]
  notes                     Note[]
  notifications             Notification[]
  rateLimits                RateLimit[]
  recurringDeadlinePatterns RecurringDeadlinePattern[]
  recurringExamPatterns     RecurringExamPattern[]
  recurringPatterns         RecurringPattern[]
  settings                  Settings?
  shoppingItems             ShoppingItem[]
  tasks                     Task[]
  calendarEvents            CalendarEvent[]
  deletedCanvasItems        DeletedCanvasItem[]
  deletedBlackboardItems    DeletedBlackboardItem[]
  deletedMoodleItems        DeletedMoodleItem[]
  deletedBrightspaceItems   DeletedBrightspaceItem[]
  workItems                 WorkItem[]
  recurringWorkPatterns     RecurringWorkPattern[]
  betaFeedback              BetaFeedback[]
  streak                    UserStreak?
  achievements              UserAchievement[]
  dailyActivities           DailyActivity[]

  // Friend relations
  sentFriendRequests     FriendRequest[] @relation("SentRequests")
  receivedFriendRequests FriendRequest[] @relation("ReceivedRequests")
  friendsAsUser1         Friendship[]    @relation("FriendUser1")
  friendsAsUser2         Friendship[]    @relation("FriendUser2")
  monthlyXpTotals        MonthlyXpTotal[]

  // Referral Program
  referralCode      String?   @unique  // User's shareable referral code (e.g., "ABCD1234")
  referredById      String?             // ID of user who referred them
  referredBy        User?     @relation("ReferralRelation", fields: [referredById], references: [id])
  referrals         User[]    @relation("ReferralRelation")
  sentReferrals     Referral[] @relation("SentReferrals")
  receivedReferral  Referral?  @relation("ReceivedReferral")
  flashcardDecks          FlashcardDeck[]
  dailyChallengeRewards   DailyChallengeReward[]

  @@index([email])
  @@index([username])
  @@index([collegeId])
  @@index([subscriptionTier])
  @@index([stripeCustomerId])
  @@index([referralCode])
}

model Course {
  id           String    @id @default(cuid())
  userId       String
  code         String
  name         String
  term         String
  credits      Float?
  meetingTimes Json      @default("[]")
  links        Json      @default("[]")
  files        Json      @default("[]")
  colorTag     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  startDate    DateTime?
  endDate      DateTime?

  // Canvas LMS Integration
  canvasCourseId     String?
  canvasEnrollmentId String?

  // Blackboard LMS Integration
  blackboardCourseId     String?
  blackboardEnrollmentId String?

  // Moodle LMS Integration
  moodleCourseId     String?
  moodleEnrollmentId String?

  // Brightspace LMS Integration
  brightspaceCourseId     String?
  brightspaceEnrollmentId String?

  // Learning Suite (BYU) Integration
  learningSuiteCourseId String?

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  deadlines      Deadline[]
  exams          Exam[]
  excludedDates  ExcludedDate[]
  folders        Folder[]
  gpaEntries     GpaEntry[]
  notes          Note[]
  tasks          Task[]
  workItems      WorkItem[]
  flashcardDecks FlashcardDeck[]

  @@index([userId])
  @@index([canvasCourseId])
  @@index([blackboardCourseId])
  @@index([moodleCourseId])
  @@index([brightspaceCourseId])
  @@index([learningSuiteCourseId])
}

model Deadline {
  id                 String    @id @default(cuid())
  userId             String
  title              String
  courseId           String?
  dueAt              DateTime?
  priority           Int?
  effort             String?
  notes              String    @default("")
  tags               Json      @default("[]")
  status             String    @default("open")
  workingOn          Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  links              Json      @default("[]")
  files              Json      @default("[]")
  instanceDate       DateTime?
  isRecurring        Boolean   @default(false)
  recurringPatternId String?

  // Canvas LMS Integration
  canvasAssignmentId   String?
  canvasSubmissionId   String?
  canvasPointsPossible Float?
  canvasPointsEarned   Float?
  canvasGradePostedAt  DateTime?

  course           Course?                   @relation(fields: [courseId], references: [id])
  recurringPattern RecurringDeadlinePattern? @relation(fields: [recurringPatternId], references: [id])
  user             User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  linkedNotes      Note[]
  reminders        DeadlineReminder[]
  notifications    Notification[]

  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@index([recurringPatternId])
  @@index([isRecurring])
  @@index([canvasAssignmentId])
  @@index([dueAt])
}

model Task {
  id                 String            @id @default(cuid())
  userId             String
  title              String
  courseId           String?
  dueAt              DateTime?
  pinned             Boolean           @default(false)
  importance         String?
  checklist          Json              @default("[]")
  notes              String            @default("")
  tags               Json              @default("[]")
  status             String            @default("open")
  workingOn          Boolean           @default(false)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  links              Json              @default("[]")
  files              Json              @default("[]")
  instanceDate       DateTime?
  isRecurring        Boolean           @default(false)
  recurringPatternId String?
  course             Course?           @relation(fields: [courseId], references: [id])
  recurringPattern   RecurringPattern? @relation(fields: [recurringPatternId], references: [id])
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  linkedNotes        Note[]
  reminders          TaskReminder[]
  notifications      Notification[]

  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@index([pinned])
  @@index([recurringPatternId])
  @@index([isRecurring])
  @@index([dueAt])
}

model RecurringPattern {
  id              String    @id @default(cuid())
  userId          String
  recurrenceType  String
  intervalDays    Int?
  endDate         DateTime?
  occurrenceCount Int?
  lastGenerated   DateTime  @default(now())
  instanceCount   Int       @default(0)
  taskTemplate    Json
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  isActive        Boolean   @default(true)
  daysOfWeek      Json      @default("[]")
  daysOfMonth     Json      @default("[]")
  startDate       DateTime?
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks           Task[]
  linkedNotes     Note[]

  @@index([userId])
  @@index([isActive])
}

model RecurringDeadlinePattern {
  id               String     @id @default(cuid())
  userId           String
  recurrenceType   String
  intervalDays     Int?
  daysOfWeek       Json       @default("[]")
  daysOfMonth      Json       @default("[]")
  startDate        DateTime?
  endDate          DateTime?
  occurrenceCount  Int?
  lastGenerated    DateTime   @default(now())
  instanceCount    Int        @default(0)
  deadlineTemplate Json
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  isActive         Boolean    @default(true)
  deadlines        Deadline[]
  linkedNotes      Note[]
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model RecurringExamPattern {
  id              String    @id @default(cuid())
  userId          String
  recurrenceType  String
  intervalDays    Int?
  daysOfWeek      Json      @default("[]")
  daysOfMonth     Json      @default("[]")
  startDate       DateTime?
  endDate         DateTime?
  occurrenceCount Int?
  lastGenerated   DateTime  @default(now())
  instanceCount   Int       @default(0)
  examTemplate    Json
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  isActive        Boolean   @default(true)
  exams           Exam[]
  linkedNotes     Note[]
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model Exam {
  id                 String                @id @default(cuid())
  userId             String
  title              String
  courseId           String?
  examAt             DateTime?
  location           String?
  notes              String                @default("")
  tags               Json                  @default("[]")
  status             String                @default("scheduled")
  links              Json                  @default("[]")
  files              Json                  @default("[]")
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  instanceDate       DateTime?
  isRecurring        Boolean               @default(false)
  recurringPatternId String?
  course             Course?               @relation(fields: [courseId], references: [id])
  recurringPattern   RecurringExamPattern? @relation(fields: [recurringPatternId], references: [id])
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  reminders          ExamReminder[]
  notifications      Notification[]
  linkedNotes        Note[]

  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@index([examAt])
  @@index([recurringPatternId])
  @@index([isRecurring])
}

model ExamReminder {
  id             String   @id @default(cuid())
  examId         String
  reminderType   String
  sentAt         DateTime @default(now())
  notificationId String?
  exam           Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@unique([examId, reminderType])
  @@index([examId])
  @@index([sentAt])
}

model DeadlineReminder {
  id             String   @id @default(cuid())
  deadlineId     String
  reminderType   String
  sentAt         DateTime @default(now())
  notificationId String?
  deadline       Deadline @relation(fields: [deadlineId], references: [id], onDelete: Cascade)

  @@unique([deadlineId, reminderType])
  @@index([deadlineId])
  @@index([sentAt])
}

model TaskReminder {
  id             String   @id @default(cuid())
  taskId         String
  reminderType   String
  sentAt         DateTime @default(now())
  notificationId String?
  task           Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, reminderType])
  @@index([taskId])
  @@index([sentAt])
}

model Note {
  id                         String                    @id @default(cuid())
  userId                     String
  title                      String
  content                    Json                      @default("{}")
  plainText                  String                    @default("")
  folderId                   String?
  courseId                   String?
  taskId                     String?
  deadlineId                 String?
  examId                     String?
  workItemId                 String?
  recurringTaskPatternId     String?
  recurringDeadlinePatternId String?
  recurringExamPatternId     String?
  recurringWorkPatternId     String?
  tags                       Json                      @default("[]")
  isPinned                   Boolean                   @default(false)
  links                      Json                      @default("[]")
  files                      Json                      @default("[]")
  createdAt                  DateTime                  @default(now())
  updatedAt                  DateTime                  @updatedAt
  course                     Course?                   @relation(fields: [courseId], references: [id])
  folder                     Folder?                   @relation(fields: [folderId], references: [id])
  task                       Task?                     @relation(fields: [taskId], references: [id], onDelete: SetNull)
  deadline                   Deadline?                 @relation(fields: [deadlineId], references: [id], onDelete: SetNull)
  exam                       Exam?                     @relation(fields: [examId], references: [id], onDelete: SetNull)
  workItem                   WorkItem?                 @relation(fields: [workItemId], references: [id], onDelete: SetNull)
  recurringTaskPattern       RecurringPattern?         @relation(fields: [recurringTaskPatternId], references: [id], onDelete: SetNull)
  recurringDeadlinePattern   RecurringDeadlinePattern? @relation(fields: [recurringDeadlinePatternId], references: [id], onDelete: SetNull)
  recurringExamPattern       RecurringExamPattern?     @relation(fields: [recurringExamPatternId], references: [id], onDelete: SetNull)
  recurringWorkPattern       RecurringWorkPattern?     @relation(fields: [recurringWorkPatternId], references: [id], onDelete: SetNull)
  user                       User                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([folderId])
  @@index([courseId])
  @@index([taskId])
  @@index([deadlineId])
  @@index([examId])
  @@index([workItemId])
  @@index([recurringTaskPatternId])
  @@index([recurringDeadlinePatternId])
  @@index([recurringExamPatternId])
  @@index([recurringWorkPatternId])
  @@index([isPinned])
}

model Folder {
  id        String   @id @default(cuid())
  userId    String
  name      String
  parentId  String?
  courseId  String?
  colorTag  String?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course?  @relation(fields: [courseId], references: [id])
  parent    Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  Folder[] @relation("FolderHierarchy")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  notes     Note[]

  @@unique([userId, name, parentId])
  @@index([userId])
  @@index([parentId])
  @@index([courseId])
}

model GpaEntry {
  id         String   @id @default(cuid())
  userId     String
  courseId   String?
  courseName String
  grade      String
  credits    Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  university String?
  status     String   @default("final")
  term       String   @default("")
  course     Course?  @relation(fields: [courseId], references: [id])
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([university])
  @@index([term])
  @@index([status])
}

model Settings {
  id                           String   @id @default(cuid())
  userId                       String   @unique
  dueSoonWindowDays            Int      @default(7)
  weekStartsOn                 String   @default("Sun")
  timeFormat                   String   @default("12h")
  dateFormat                   String   @default("MM/DD/YYYY")
  theme                        String   @default("dark")
  enableNotifications          Boolean  @default(false)
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt
  university                   String?
  visibleDashboardCards        Json?    @default("[\"nextClass\", \"dueSoon\", \"overview\", \"todayTasks\", \"quickLinks\", \"upcomingWeek\"]")
  visiblePages                 Json?    @default("[\"Dashboard\", \"Calendar\", \"Tasks\", \"Assignments\", \"Exams\", \"Courses\", \"Tools\", \"Settings\"]")
  visibleToolsCards            Json?    @default("[\"quickLinks\", \"gpaCalculator\"]")
  hasCompletedOnboarding       Boolean  @default(false)
  examReminders                Json?    @default("[{\"unit\": \"days\", \"value\": 7, \"enabled\": false}, {\"unit\": \"days\", \"value\": 1, \"enabled\": false}, {\"unit\": \"hours\", \"value\": 3, \"enabled\": false}]")
  deadlineReminders            Json?    @default("[{\"unit\": \"days\", \"value\": 1, \"enabled\": false}, {\"unit\": \"hours\", \"value\": 3, \"enabled\": false}]")
  taskReminders                Json?    @default("[{\"unit\": \"days\", \"value\": 1, \"enabled\": false}, {\"unit\": \"hours\", \"value\": 3, \"enabled\": false}]")
  pomodoroBreakDuration        Int      @default(5)
  pomodoroIsMuted              Boolean  @default(false)
  pomodoroWorkDuration         Int      @default(25)
  selectedGradeSemester        String   @default("all")
  toolsCardsOrder              Json?    @default("[\"pomodoroTimer\", \"gradeTracker\", \"gpaTrendChart\", \"whatIfProjector\", \"gpaCalculator\", \"tools_quickLinks\"]")
  visiblePagesOrder            Json?    @default("[\"Dashboard\", \"Calendar\", \"Tasks\", \"Assignments\", \"Exams\", \"Notes\", \"Courses\", \"Tools\"]")
  dashboardCardsCollapsedState Json?    @default("[]")
  hiddenQuickLinks             Json?    @default("{}")
  courseTermFilter             String   @default("all")
  emailAnnouncements           Boolean  @default(false)
  emailExamReminders           Boolean  @default(false)
  emailAccountAlerts           Boolean  @default(false)
  emailDeadlineReminders       Boolean  @default(false)
  emailTaskReminders           Boolean  @default(false)
  emailWeeklyDigest            Boolean  @default(false)
  notifyAnnouncements          Boolean  @default(false)
  notifyExamReminders          Boolean  @default(false)
  notifyAccountAlerts          Boolean  @default(false)
  notifyDeadlineReminders      Boolean  @default(false)
  notifyTaskReminders          Boolean  @default(false)
  useCustomTheme               Boolean  @default(false)
  customColors                 Json?
  gradientIntensity            Int      @default(50)
  glowIntensity                Int      @default(50)
  autoCreateCourseFolders      Boolean  @default(false)
  showCanvasBadges             Boolean  @default(true)
  showRelativeDates            Boolean  @default(false)
  showNavCounts                Boolean  @default(false)
  showNavCountTasks            Boolean  @default(true)
  showNavCountAssignments      Boolean  @default(true)
  showNavCountExams            Boolean  @default(true)
  showPriorityIndicators       Boolean  @default(true)
  showEffortIndicators         Boolean  @default(true)
  groupTasksByCourse           Boolean  @default(false)
  groupAssignmentsByCourse     Boolean  @default(false)
  showCourseCode               Boolean  @default(false)
  confirmBeforeDelete          Boolean  @default(true)
  enableKeyboardShortcuts      Boolean  @default(true)

  // Demo Data
  hasDemoData                  Boolean  @default(false)

  // Beta Program
  isBetaUser                   Boolean  @default(false)

  // Colorblind Accessibility
  colorblindMode  String? // 'protanopia', 'deuteranopia', 'tritanopia', 'achromatopsia', or null for off
  colorblindStyle String? // 'palette', 'patterns', 'both', or null for default

  // Canvas LMS Integration
  canvasInstanceUrl       String?
  canvasAccessToken       String?
  canvasUserId            String?
  canvasUserName          String?
  canvasSyncEnabled       Boolean   @default(false)
  canvasLastSyncedAt      DateTime?
  canvasSyncCourses       Boolean   @default(true)
  canvasSyncAssignments   Boolean   @default(true)
  canvasSyncGrades        Boolean   @default(true)
  canvasSyncEvents        Boolean   @default(true)
  canvasSyncAnnouncements Boolean   @default(true)
  canvasAutoMarkComplete  Boolean   @default(true)

  // Blackboard LMS Integration
  blackboardInstanceUrl       String?
  blackboardApplicationKey    String?   // OAuth app key
  blackboardApplicationSecret String?   // OAuth app secret (encrypted)
  blackboardAccessToken       String?   // OAuth token (encrypted, auto-refreshes)
  blackboardTokenExpiresAt    DateTime?
  blackboardUserId            String?
  blackboardUserName          String?
  blackboardSyncEnabled       Boolean   @default(false)
  blackboardLastSyncedAt      DateTime?
  blackboardSyncCourses       Boolean   @default(true)
  blackboardSyncAssignments   Boolean   @default(true)
  blackboardSyncGrades        Boolean   @default(true)
  blackboardSyncEvents        Boolean   @default(true)
  blackboardAutoMarkComplete  Boolean   @default(true)

  // Moodle LMS Integration
  moodleInstanceUrl        String?
  moodleAccessToken        String?   // Web service token (encrypted)
  moodleUserId             String?
  moodleUserName           String?
  moodleSyncEnabled        Boolean   @default(false)
  moodleLastSyncedAt       DateTime?
  moodleSyncCourses        Boolean   @default(true)
  moodleSyncAssignments    Boolean   @default(true)
  moodleSyncGrades         Boolean   @default(true)
  moodleSyncEvents         Boolean   @default(true)
  moodleSyncAnnouncements  Boolean   @default(true)
  moodleAutoMarkComplete   Boolean   @default(true)

  // Brightspace (D2L) LMS Integration
  brightspaceInstanceUrl        String?
  brightspaceClientId           String?   // OAuth client ID
  brightspaceClientSecret       String?   // OAuth client secret (encrypted)
  brightspaceAccessToken        String?   // OAuth access token (encrypted)
  brightspaceRefreshToken       String?   // OAuth refresh token (encrypted)
  brightspaceTokenExpiresAt     DateTime?
  brightspaceUserId             String?
  brightspaceUserName           String?
  brightspaceSyncEnabled        Boolean   @default(false)
  brightspaceLastSyncedAt       DateTime?
  brightspaceSyncCourses        Boolean   @default(true)
  brightspaceSyncAssignments    Boolean   @default(true)
  brightspaceSyncGrades         Boolean   @default(true)
  brightspaceSyncEvents         Boolean   @default(true)
  brightspaceSyncAnnouncements  Boolean   @default(true)
  brightspaceAutoMarkComplete   Boolean   @default(true)

  // Flashcard Settings
  flashcardDefaultMode        String?   @default("flashcard") // 'flashcard', 'type', 'match'
  flashcardCardsPerSession    Int       @default(20)          // 0 = all, otherwise limit
  flashcardDailyGoal          Int       @default(20)
  flashcardShuffleOrder       Boolean   @default(true)
  flashcardAutoFlipDelay      Int       @default(0)           // 0 = off, otherwise seconds
  flashcardShowKeyboardHints  Boolean   @default(true)
  flashcardSoundEffects       Boolean   @default(true)
  flashcardCelebrations       Boolean   @default(true)
  flashcardDefaultSort        String?   @default("recent")    // 'recent', 'due', 'alpha', 'course', 'mastery', 'created'

  // Spotify Integration
  spotifyAccessToken        String?   // OAuth access token (encrypted)
  spotifyRefreshToken       String?   // OAuth refresh token (encrypted)
  spotifyTokenExpiresAt     DateTime?
  spotifyUserId             String?
  spotifyUserName           String?
  spotifyProfileImage       String?
  spotifyProduct            String?   // "premium" | "free" | "open"
  spotifyConnected          Boolean   @default(false)
  spotifyMiniPlayerSize     String    @default("medium") // "big" | "medium" | "mini"
  spotifyVisualizerEnabled  Boolean   @default(true)

  // Visual Themes (Premium)
  visualTheme               String?   @default("default")

  // Pet Companion (Premium)
  petCompanion              Boolean   @default(false)
  petCompanionAnimal        String?   @default("dog")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CollegeRequest {
  id            String         @id @default(cuid())
  userId        String
  collegeName   String
  status        String         @default("pending")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@index([userId])
  @@index([status])
}

model IssueReport {
  id            String         @id @default(cuid())
  userId        String
  description   String
  status        String         @default("pending")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@index([userId])
  @@index([status])
}

model FeatureRequest {
  id            String         @id @default(cuid())
  userId        String
  description   String
  status        String         @default("pending")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@index([userId])
  @@index([status])
}

model ExcludedDate {
  id          String   @id @default(cuid())
  userId      String
  courseId    String?
  date        DateTime
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  course      Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
  @@index([date])
}

model Notification {
  id               String   @id @default(cuid())
  userId           String
  title            String
  message          String
  type             String
  read             Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  collegeRequestId String?
  featureRequestId String?
  issueReportId    String?
  examId           String?
  deadlineId       String?
  taskId           String?
  workItemId       String?
  betaFeedbackId   String?

  // Canvas LMS Integration
  canvasAnnouncementId String?

  collegeRequest CollegeRequest? @relation(fields: [collegeRequestId], references: [id], onDelete: Cascade)
  exam           Exam?           @relation(fields: [examId], references: [id], onDelete: Cascade)
  deadline       Deadline?       @relation(fields: [deadlineId], references: [id], onDelete: Cascade)
  task           Task?           @relation(fields: [taskId], references: [id], onDelete: Cascade)
  workItem       WorkItem?       @relation(fields: [workItemId], references: [id], onDelete: Cascade)
  featureRequest FeatureRequest? @relation(fields: [featureRequestId], references: [id], onDelete: Cascade)
  issueReport    IssueReport?    @relation(fields: [issueReportId], references: [id], onDelete: Cascade)
  betaFeedback   BetaFeedback?   @relation(fields: [betaFeedbackId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([collegeRequestId])
  @@index([issueReportId])
  @@index([featureRequestId])
  @@index([examId])
  @@index([deadlineId])
  @@index([taskId])
  @@index([workItemId])
  @@index([betaFeedbackId])
  @@index([canvasAnnouncementId])
}

model RateLimit {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  count     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@index([resetAt])
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  sessionId String
  userId    String?
  eventType String
  eventName String
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
}

model CustomQuickLink {
  id         String   @id @default(cuid())
  userId     String
  university String
  label      String
  url        String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([university])
}

model ShoppingItem {
  id          String    @id @default(cuid())
  userId      String
  listType    String // "grocery" | "wishlist" | "pantry"
  name        String
  quantity    Int       @default(1)
  unit        String?
  category    String
  notes       String    @default("")
  checked     Boolean   @default(false)
  priority    String? // "low" | "medium" | "high"
  price       Float?
  perishable  Boolean?  @default(false)
  order       Int       @default(0) // For manual reordering within category
  purchasedAt DateTime? // When item was purchased/cleared (null = active item)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([listType])
  @@index([category])
  @@index([checked])
  @@index([purchasedAt])
}

model CalendarEvent {
  id          String    @id @default(cuid())
  userId      String
  title       String
  description String    @default("")
  startAt     DateTime
  endAt       DateTime?
  allDay      Boolean   @default(false)
  color       String?
  location    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Canvas LMS Integration
  canvasEventId String?

  // Blackboard LMS Integration
  blackboardEventId String?

  // Moodle LMS Integration
  moodleEventId String?

  // Brightspace LMS Integration
  brightspaceEventId String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startAt])
  @@index([canvasEventId])
  @@index([blackboardEventId])
  @@index([moodleEventId])
  @@index([brightspaceEventId])
}

model AuditLog {
  id           String   @id @default(cuid())
  adminId      String
  adminEmail   String
  action       String // grant_premium, revoke_premium, grant_admin, revoke_admin, send_announcement, approve_college_request, reject_college_request, approve_issue_report, reject_issue_report, approve_feature_request, reject_feature_request
  targetUserId String?
  targetEmail  String?
  details      Json? // Additional context (announcement title, request details, etc.)
  createdAt    DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

model College {
  id          String   @id @default(cuid())
  fullName    String   @unique
  acronym     String
  darkAccent  String // Accent color for dark mode
  darkLink    String // Link color for dark mode
  lightAccent String // Accent color for light mode
  lightLink   String // Link color for light mode
  quickLinks  Json     @default("[]") // Array of {label, url} objects
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users           User[]
  monthlyXpTotals MonthlyXpTotal[]

  @@index([isActive])
  @@index([fullName])
}

model DeletedCanvasItem {
  id        String   @id @default(cuid())
  userId    String
  canvasId  String // The Canvas ID (canvasAssignmentId, canvasCourseId, etc.)
  type      String // 'assignment', 'course', 'event', 'announcement'
  deletedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, canvasId, type])
  @@index([userId, type])
}

model DeletedBlackboardItem {
  id           String   @id @default(cuid())
  userId       String
  blackboardId String // The Blackboard ID (blackboardColumnId, blackboardCourseId, etc.)
  type         String // 'assignment', 'course', 'event'
  deletedAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, blackboardId, type])
  @@index([userId, type])
}

model DeletedMoodleItem {
  id        String   @id @default(cuid())
  userId    String
  moodleId  String // The Moodle ID (moodleAssignmentId, moodleCourseId, etc.)
  type      String // 'assignment', 'course', 'event', 'announcement'
  deletedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moodleId, type])
  @@index([userId, type])
}

model DeletedBrightspaceItem {
  id            String   @id @default(cuid())
  userId        String
  brightspaceId String // The Brightspace ID (brightspaceActivityId, brightspaceCourseId, etc.)
  type          String // 'assignment', 'course', 'event', 'announcement'
  deletedAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, brightspaceId, type])
  @@index([userId, type])
}

model UserSession {
  id             String    @id @default(cuid())
  userId         String
  sessionToken   String    @unique
  userAgent      String?
  browser        String?
  os             String?
  device         String?
  ipAddress      String?
  city           String?
  country        String?
  lastActivityAt DateTime  @default(now())
  createdAt      DateTime  @default(now())
  expiresAt      DateTime
  isCurrent      Boolean   @default(false)
  revokedAt      DateTime? // When set, this session is revoked

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([expiresAt])
}

// Unified Work Item model - replaces Task and Deadline
model WorkItem {
  id                 String    @id @default(cuid())
  userId             String
  title              String
  type               String // 'task' | 'assignment' | 'reading' | 'project'
  courseId           String?
  dueAt              DateTime?
  priority           String? // 'low' | 'medium' | 'high' | 'critical'
  effort             String? // 'small' | 'medium' | 'large'
  pinned             Boolean   @default(false)
  checklist          Json      @default("[]")
  notes              String    @default("")
  tags               Json      @default("[]")
  status             String    @default("open")
  workingOn          Boolean   @default(false)
  links              Json      @default("[]")
  files              Json      @default("[]")
  instanceDate       DateTime?
  isRecurring        Boolean   @default(false)
  recurringPatternId String?

  // Canvas LMS Integration
  canvasAssignmentId   String?
  canvasSubmissionId   String?
  canvasPointsPossible Float?
  canvasPointsEarned   Float?
  canvasGradePostedAt  DateTime?

  // Blackboard LMS Integration
  blackboardColumnId       String?   // gradebook column ID
  blackboardAttemptId      String?   // submission attempt ID
  blackboardPointsPossible Float?
  blackboardPointsEarned   Float?
  blackboardGradePostedAt  DateTime?

  // Moodle LMS Integration
  moodleAssignmentId     String?
  moodleSubmissionId     String?
  moodlePointsPossible   Float?
  moodlePointsEarned     Float?
  moodleGradePostedAt    DateTime?

  // Brightspace LMS Integration
  brightspaceActivityId    String?
  brightspaceSubmissionId  String?
  brightspacePointsPossible Float?
  brightspacePointsEarned   Float?
  brightspaceGradePostedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  course           Course?               @relation(fields: [courseId], references: [id])
  recurringPattern RecurringWorkPattern? @relation(fields: [recurringPatternId], references: [id])
  linkedNotes      Note[]
  reminders        WorkItemReminder[]
  notifications    Notification[]

  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@index([type])
  @@index([pinned])
  @@index([recurringPatternId])
  @@index([isRecurring])
  @@index([canvasAssignmentId])
  @@index([blackboardColumnId])
  @@index([moodleAssignmentId])
  @@index([brightspaceActivityId])
  @@index([dueAt])
}

model RecurringWorkPattern {
  id               String    @id @default(cuid())
  userId           String
  recurrenceType   String
  intervalDays     Int?
  daysOfWeek       Json      @default("[]")
  daysOfMonth      Json      @default("[]")
  startDate        DateTime?
  endDate          DateTime?
  occurrenceCount  Int?
  lastGenerated    DateTime  @default(now())
  instanceCount    Int       @default(0)
  workItemTemplate Json
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workItems   WorkItem[]
  linkedNotes Note[]

  @@index([userId])
  @@index([isActive])
}

model WorkItemReminder {
  id             String   @id @default(cuid())
  workItemId     String
  reminderType   String
  sentAt         DateTime @default(now())
  notificationId String?

  workItem WorkItem @relation(fields: [workItemId], references: [id], onDelete: Cascade)

  @@unique([workItemId, reminderType])
  @@index([workItemId])
}

model BetaFeedback {
  id            String         @id @default(cuid())
  userId        String
  description   String
  status        String         @default("pending") // pending, reviewed, resolved
  adminResponse String?
  respondedAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@index([userId])
  @@index([status])
}

model AppVersion {
  id           String   @id @default(cuid())
  version      String   @unique
  changes      Json     @default("[]")
  isBetaOnly   Boolean  @default(true)
  releasedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isBetaOnly])
  @@index([releasedAt])
}

// Gamification Models
model UserStreak {
  id                  String    @id @default(cuid())
  userId              String    @unique
  currentStreak       Int       @default(0)
  longestStreak       Int       @default(0)
  lastActivityDate    DateTime?
  streakStartDate     DateTime?
  totalTasksCompleted Int       @default(0)
  totalXp             Int       @default(0)
  level               Int       @default(1)
  vacationMode        Boolean   @default(false)
  vacationStartedAt   DateTime?
  earlyBirdCount      Int       @default(0) // Completions before 8 AM
  nightOwlCount       Int       @default(0) // Completions after 11 PM
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Track which items have already been credited for XP (prevents exploit of toggling done/undone)
model GamificationCredit {
  id        String   @id @default(cuid())
  userId    String
  itemType  String   // "task", "deadline", "exam", "workItem"
  itemId    String
  xpAwarded Int
  createdAt DateTime @default(now())

  @@unique([userId, itemType, itemId])
  @@index([userId])
}

model Achievement {
  id               String            @id @default(cuid())
  key              String            @unique
  name             String
  description      String
  icon             String
  category         String // "streak", "completion", "milestone", "consistency"
  xpReward         Int               @default(0)
  tier             String            @default("bronze") // "bronze", "silver", "gold", "platinum"
  requirement      Json // { type: "streak" | "tasks" | "time", value: number }
  isSecret         Boolean           @default(false)
  userAchievements UserAchievement[]

  @@index([category])
  @@index([tier])
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  earnedAt      DateTime    @default(now())
  notified      Boolean     @default(false)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
}

model DailyActivity {
  id             String   @id @default(cuid())
  userId         String
  activityDate   DateTime @db.Date
  tasksCompleted Int      @default(0)
  xpEarned       Int      @default(0)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, activityDate])
  @@index([userId])
  @@index([activityDate])
}

// Friends System Models
model FriendRequest {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  status     String   @default("pending") // pending, accepted, declined
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sender   User @relation("SentRequests", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedRequests", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
}

model Friendship {
  id        String   @id @default(cuid())
  user1Id   String   // Lower lexicographic ID
  user2Id   String   // Higher lexicographic ID
  createdAt DateTime @default(now())

  user1 User @relation("FriendUser1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2 User @relation("FriendUser2", fields: [user2Id], references: [id], onDelete: Cascade)

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
}

model MonthlyXpTotal {
  id        String   @id @default(cuid())
  userId    String
  collegeId String
  yearMonth String   // Format: "2026-01"
  totalXp   Int      @default(0)
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  college College @relation(fields: [collegeId], references: [id], onDelete: Cascade)

  @@unique([userId, yearMonth])
  @@index([collegeId, yearMonth])
}

// Referral Program
model Referral {
  id           String    @id @default(cuid())
  referrerId   String                          // Who referred
  refereeId    String    @unique               // Who was referred (1 referral per user)
  status       String    @default("pending")   // pending, completed, expired
  rewardMonths Int       @default(1)           // Months awarded
  rewardedAt   DateTime?                       // When referrer was rewarded
  createdAt    DateTime  @default(now())

  referrer     User      @relation("SentReferrals", fields: [referrerId], references: [id], onDelete: Cascade)
  referee      User      @relation("ReceivedReferral", fields: [refereeId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([status])
}

model FlashcardDeck {
  id          String      @id @default(cuid())
  userId      String
  name        String
  description String?
  courseId    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course?     @relation(fields: [courseId], references: [id])
  cards       Flashcard[]

  @@index([userId])
  @@index([courseId])
}

model Flashcard {
  id          String    @id @default(cuid())
  deckId      String
  front       String
  back        String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Spaced repetition fields (SM-2 algorithm)
  interval    Int       @default(1)      // Days until next review
  easeFactor  Float     @default(2.5)    // Difficulty multiplier
  repetitions Int       @default(0)      // Number of correct reviews
  nextReview  DateTime  @default(now())  // When to show next

  deck        FlashcardDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@index([deckId])
  @@index([nextReview])
}

// Partner Program Inquiries (clubs, educators, partners)
model PartnerInquiry {
  id           String   @id @default(cuid())
  type         String   // 'club', 'educator', 'partner'
  status       String   @default("pending") // 'pending', 'contacted', 'completed', 'declined'

  // Common fields
  email        String
  name         String?

  // Club-specific fields
  clubName     String?
  school       String?
  memberCount  String?
  platform     String?  // discord, groupme, slack, instagram, email, other

  // Partner-specific fields
  role         String?  // tutor, academic-coach, content-creator, org-leader, ta, other
  audienceSize String?
  website      String?

  // Tracking
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([email])
}

model DailyChallengeReward {
  id          String   @id @default(cuid())
  userId      String
  challengeId String
  dateKey     String   // YYYY-MM-DD in user's local timezone
  xpAwarded   Int
  claimedAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId, dateKey])
  @@index([userId])
  @@index([dateKey])
}
